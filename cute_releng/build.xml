<project default="build">

	<target name="hi">
		<echo message="${eclipse.home}"/>
	</target>
	
	<target name="build" depends="hi,zips,test"/>
	
	<target name="init">
		<!-- <touch file="${user.home}/.cvspass" /> -->
		<tstamp/>
		<property name="branchVersion" value="1.0.0"/>
		<property name="testVersion" value="1.0.0"/>
		<property name="timestamp" value="${DSTAMP}${TSTAMP}" />
		<property name="forceContextQualifier" value="${timestamp}"/>
		<property name="buildDirectory" value="${basedir}/results" />
		<property name="baseLocation" value="${buildDirectory}/eclipse"/>
		<property name="eclipse.home" value="${buildDirectory}/eclipse"/>
		<property name="pde.build.scripts" value="${eclipse.home}/plugins/org.eclipse.pde.build/scripts"/>
		<property name="eclipseDist" value="eclipse-SDK-3.2.2-linux-gtk-cdt"/>
		<property name="collectingFolder" value="eclipse"/>
		<property name="archivePrefix" value="eclipse"/>
		<property name="buildType" value="I" />
		<property name="buildId" value="${buildType}${timestamp}"/>
		<property name="zipsdir" value="${buildDirectory}/${buildType}.${buildId}"/>
		<property name="UpdateSiteStagingLocation" value="${zipsdir}/updateSite"/>
		<property name="milestonedir" value="${buildDirectory}/${milestone}"/>
		<property name="buildingOSGi" value="true"/>
		<property name="eclipseRoot" value=":pserver:anonymous@dev.eclipse.org:/home/eclipse"/>
		<property name="baseos" value="${osgi.os}"/>
		<property name="basews" value="${osgi.ws}"/>
		<property name="basearch" value="${osgi.arch}"/>
		<property name="tagname" value="v${timestamp}"/>
		<condition property="onWindows">
			<os family="windows"/>
		</condition>
		<mkdir dir="${buildDirectory}"/>
	</target>
	
	<target name="fetch" depends="init">
		<ant antfile="build.xml" dir="${pde.build.scripts}" target="preBuild">
			<property name="builder" value="${basedir}/feature"/>
		</ant>
	</target>
	
	<target name="unzip" depends="init" unless="dontUnzip">
		<antcall target="unpack">
			<param name="srcPrefix" value="${eclipseDist}"/>
			<param name="dest" value="${buildDirectory}"/>
		</antcall>
	</target>
	
	<target name="zips" depends="init,unzip">
		<ant antfile="build.xml" dir="${pde.build.scripts}">
			<property name="builder" value="${basedir}/feature" />
		</ant>
		<concat destfile="${zipsdir}/compilelog.txt">
			<fileset dir="${buildDirectory}/plugins" includes="**/*.bin.log"/>
		</concat>
		<!--<loadfile property="compileLog" srcFile="${zipsdir}/compilelog.txt"/>
		<condition property="hasErrors">
			<contains string="${compileLog}" substring=" ERROR"/>
		</condition>-->
		<copy file="buildindex.html" tofile="${zipsdir}/index.html"/>
		<replace file="${zipsdir}/index.html">
			<replacefilter token="@branchVersion@" value="${branchVersion}"/>
			<replacefilter token="@buildId@" value="${buildId}"/>
		</replace>
	</target>

	<target name="unpackzip" if="onWindows">
		<unzip src="${srcPrefix}.zip" dest="${dest}"/>
	</target>

	<target name="unpacktar" unless="onWindows">
		<untar src="${srcPrefix}.tar.gz" dest="${dest}"
			compression="gzip"/>
	</target>

	<target name="unpack">
		<antcall target="unpackzip"/>
		<antcall target="unpacktar"/>
	</target>
	
	<target name="test" depends="init" unless="hasErrors">
	    <ant antfile="build.xml" dir="${pde.build.scripts}">
			<property name="builder" value="${basedir}/testing" />
		</ant>
		<unzip src="${zipsdir}/ch.hsr.ifs.cute-${branchVersion}-${buildId}.zip" dest="${buildDirectory}"/>
		<unzip src="${zipsdir}/ch.hsr.ifs.cute.test-${testVersion}-${buildId}.zip" dest="${buildDirectory}"/>
		<ant antfile="test.xml" dir="${buildDirectory}/eclipse/plugins/ch.hsr.ifs.cutelauncher.test_${testVersion}.${forceContextQualifier}">
			<property name="eclipse-home" value="${buildDirectory}/eclipse"/>
			<property name="library-file" value="${buildDirectory}/eclipse/plugins/org.eclipse.test_3.1.0/library.xml"/>
			<property name="os" value="${baseos}"/>
			<property name="ws" value="${basews}"/>
			<property name="arch" value="${basearch}"/>
		</ant>
		<xslt style="${basedir}/JUNIT.XSL"
			in="${buildDirectory}/eclipse/ch.hsr.ifs.cute.test.xml"
			out="${zipsdir}/junits.html"/>
		
	</target>
	
	
	
</project>
