<!-- CUTE Plugin Cruisecontrol Autobuild delegate script -->
<project name="build-cute"
        default="build"
        basedir="cute">

	<property name="features.dir" value="cute_releng/results/dist/updateSite/features"/>
	<property name="plugins.dir" value="cute_releng/results/dist/updateSite/plugins"/>
	<!-- - - - - - - - - - - - - - - - - - 
          target: checkoutBaseBuilder                      
         - - - - - - - - - - - - - - - - - -->
	<target name="checkoutBaseBuilder" unless="builder.available">
		<mkdir dir="cute_releng/tools" />
		<cvs cvsroot="anonymous@dev.eclipse.org:/cvsroot/eclipse" package="org.eclipse.releng.basebuilder" tag="R35_RC4" dest="cute_releng/tools" />
	</target>

	<!-- - - - - - - - - - - - - - - - - - 
          target: init                      
         - - - - - - - - - - - - - - - - - -->
	<target name="init">
		<mkdir dir="${features.dir}"/>
		<mkdir dir="${plugins.dir}"/>
	</target>


	<target name="build" depends="clean, init, checkoutReleng">
		<available file="${basedir}/cute_releng/tools/org.eclipse.releng.basebuilder/plugins/org.eclipse.equinox.launcher.jar" property="builder.available"/>
		<antcall target="checkoutBaseBuilder"/>

		<java jar="${basedir}/cute_releng/tools/org.eclipse.releng.basebuilder/plugins/org.eclipse.equinox.launcher.jar" fork="true" 
			failonerror="true" dir="${basedir}/cute_releng" resultproperty="error">
			<arg line="-ws gtk -os linux -application org.eclipse.ant.core.antRunner" />
		</java>

		<copy todir="cute_releng/results/dist" 
			flatten="true">
			<fileset dir="cute_releng/results">
				<include name="I*/*.html"/>
				<include name="I*/*.txt"/>
				<include name="I*/*.zip"/>
				<include name="I*/*.tar.gz"/>
			</fileset>
		</copy>
		<copy todir="${features.dir}" flatten="true">
			<fileset dir="cute_releng/results">
				<include name="I*/updateSite/features/*.jar" />
			</fileset>
		</copy>
		<copy todir="${plugins.dir}" flatten="true">
			<fileset dir="cute_releng/results">
				<include name="I*/updateSite/plugins/*.jar" />
			</fileset>
		</copy>
		<xmlproperty file="${basedir}/cute_releng/results/eclipse/ch.hsr.ifs.cute.test.xml" />

		<condition property="expected" value="0,0" else="0">
			<available file="${basedir}/cute_releng/results/eclipse/ch.hsr.ifs.cutelauncher.test.AllUiTests.xml" />
		</condition>

		<echo level="info" message="expected = ${testsuites.testsuite(errors)}" />
		<echo level="info" message="is = ${testsuites.testsuite(errors)}" />

		<condition property="testsFailed">
			<not>
				<equals arg1="${expected}" arg2="${testsuites.testsuite(errors)}" />
			</not>
		</condition>
		<fail if="testsFailed" message="Tests failed" />
	</target>

	<!-- - - - - - - - - - - - - - - - - - 
          target: checkoutReleng                      
         - - - - - - - - - - - - - - - - - -->
	<target name="checkoutReleng" depends="clean">
		<cvs cvsroot="cruisecontrol@wiki.ifs.hsr.ch:/home/cvs" command="co cute_releng" reallyquiet="true" />
	</target>


	<target name="clean">
		<delete dir="${basedir}/cute_releng/results"/>
		<delete dir="${basedir}/cute_releng/test"/>
	</target>
</project>